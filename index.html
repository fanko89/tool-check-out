<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tool Check In / Out</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background-color: #f8f9fa;
    }
    .status-badge {
      font-size: 0.75rem;
    }
    .status-ok {
      background-color: #d1e7dd;
      color: #0f5132;
    }
    .status-warning {
      background-color: #fff3cd;
      color: #664d03;
    }
    .status-danger {
      background-color: #f8d7da;
      color: #842029;
    }
    .status-info {
      background-color: #cff4fc;
      color: #055160;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-3">Tool Check In / Out</h1>
    <p class="text-muted mb-4">
      Simple tracking for company-owned tools: saws, reclaim units, specialty tools,
      etc. Based on the warehouse check in/out procedure.
    </p>

    <!-- Check Out Form -->
    <div class="card mb-4">
      <div class="card-header fw-bold">Check Out a Tool</div>
      <div class="card-body">
        <form id="checkoutForm" class="row g-3">
          <div class="col-md-4">
            <label for="toolName" class="form-label">Tool</label>
            <input type="text" id="toolName" class="form-control" required
                   placeholder="e.g. Reclaim Unit, Panel Saw" />
          </div>

          <div class="col-md-4">
            <label for="toolCondition" class="form-label">Condition at Checkout</label>
            <select id="toolCondition" class="form-select" required>
              <option value="working" selected>Working</option>
              <option value="not working">Not working</option>
            </select>
          </div>

          <div class="col-md-4">
            <label for="checkoutDate" class="form-label">Checkout Date</label>
            <input type="date" id="checkoutDate" class="form-control" required />
          </div>

          <div class="col-md-4">
            <label for="techName" class="form-label">Technician / Installer</label>
            <input type="text" id="techName" class="form-control" required
                   placeholder="Tech name" />
          </div>

          <div class="col-md-4">
            <label for="jobName" class="form-label">Job / Work Order</label>
            <input type="text" id="jobName" class="form-control" required
                   placeholder="Job name/number" />
          </div>

          <div class="col-md-12">
            <label for="reason" class="form-label">Reason for Request</label>
            <textarea id="reason" class="form-control" rows="2" required
                      placeholder="Explain why the tech requested this tool"></textarea>
          </div>

          <div class="col-12 d-flex justify-content-between align-items-center">
            <div class="text-muted small">
              Initial review at 30 days • Hard limit 90 days (exceptions by warehouse manager).
            </div>
            <button type="submit" class="btn btn-primary">
              Check Out Tool
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Active Checkouts -->
    <div class="card mb-4">
      <div class="card-header fw-bold">Active Tool Checkouts</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Tech</th>
                <th>Job</th>
                <th>Checkout Date</th>
                <th>Days Out</th>
                <th>Status</th>
                <th>Reason</th>
                <th>Condition @ Out</th>
                <th style="width: 160px;">Actions</th>
              </tr>
            </thead>
            <tbody id="activeTableBody">
              <!-- Active rows injected here -->
            </tbody>
          </table>
        </div>
        <p id="noActiveMsg" class="text-muted small mb-0 d-none">
          No active tool checkouts.
        </p>
      </div>
    </div>

    <!-- History -->
    <div class="card">
      <div class="card-header fw-bold">Returned / Closed Records</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Tech</th>
                <th>Job</th>
                <th>Checkout</th>
                <th>Return</th>
                <th>Days Out</th>
                <th>Final Status</th>
                <th>Condition @ Return</th>
                <th>Damage / Missing Notes</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <!-- History rows injected here -->
            </tbody>
          </table>
        </div>
        <p id="noHistoryMsg" class="text-muted small mb-0 d-none">
          No closed records yet.
        </p>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const STORAGE_KEY = "toolCheckouts_v1";

    // ⬇️ Paste your Apps Script Web App URL here
    const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwYebiDdugmC3KM-kXaoXKiCdq4fFXPQ3J-RI4VWGI/dev";

    let records = [];

    // --- Helpers for dates & status ---

    function todayAsInputDate() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function daysBetween(start, end) {
      const s = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      const e = new Date(end.getFullYear(), end.getMonth(), end.getDate());
      const diff = e - s;
      const msPerDay = 1000 * 60 * 60 * 24;
      return Math.floor(diff / msPerDay);
    }

    function computeStatus(rec) {
      if (rec.damagedOrMissing) {
        return {
          label: "Damaged / Missing",
          style: "status-danger"
        };
      }
      if (rec.returnDate) {
        return {
          label: "Returned",
          style: "status-info"
        };
      }
      // Active: compute based on days out
      const checkout = new Date(rec.checkoutDate);
      const now = new Date();
      const d = daysBetween(checkout, now);
      if (d > 90) {
        return {
          label: "Over 90 days – must be checked in / exception required",
          style: "status-danger"
        };
      }
      if (d > 30) {
        return {
          label: "Over 30 days – contact tech about tool",
          style: "status-warning"
        };
      }
      if (d >= 20) {
        return {
          label: "Approaching 30 days – review",
          style: "status-warning"
        };
      }
      return {
        label: "OK",
        style: "status-ok"
      };
    }

    function findRecordIndex(id) {
      return records.findIndex(r => r.id === id);
    }

    function loadRecords() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        records = [];
        return;
      }
      try {
        records = JSON.parse(raw) || [];
      } catch (e) {
        console.error("Failed to parse stored records", e);
        records = [];
      }
    }

    function saveRecords() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    // --- Google Sheets logging via Apps Script ---

    async function logToGoogleSheets(action, rec, daysOutAtEvent) {
      if (
        !GOOGLE_APPS_SCRIPT_URL ||
        GOOGLE_APPS_SCRIPT_URL.includes("https://script.google.com/macros/s/AKfycbwYebiDdugmC3KM-kXaoXKiCdq4fFXPQ3J-RI4VWGI/dev")
      ) {
        // URL not set yet; skip logging to avoid errors
        return;
      }

      const payload = {
        action,
        id: rec.id,
        toolName: rec.toolName,
        techName: rec.techName,
        jobName: rec.jobName,
        reason: rec.reason,
        checkoutDate: rec.checkoutDate,
        returnDate: rec.returnDate,
        conditionAtCheckout: rec.conditionAtCheckout,
        conditionAtReturn: rec.conditionAtReturn,
        damagedOrMissing: rec.damagedOrMissing,
        damageNotes: rec.damageNotes,
        daysOut: daysOutAtEvent
      };

      try {
        await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: "POST",
          // No headers = no preflight; Apps Script reads raw JSON fine
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error("Failed to log to Google Sheets:", err);
      }
    }

    // --- Rendering tables ---

    function renderTables() {
      const activeBody = document.getElementById("activeTableBody");
      const historyBody = document.getElementById("historyTableBody");
      const noActiveMsg = document.getElementById("noActiveMsg");
      const noHistoryMsg = document.getElementById("noHistoryMsg");

      activeBody.innerHTML = "";
      historyBody.innerHTML = "";

      let activeCount = 0;
      let historyCount = 0;

      records.forEach(rec => {
        const checkoutDate = new Date(rec.checkoutDate);
        const checkoutDateStr = checkoutDate.toLocaleDateString();

        const hasReturn = !!rec.returnDate;
        const referenceEnd = hasReturn ? new Date(rec.returnDate) : new Date();
        const daysOut = daysBetween(new Date(rec.checkoutDate), referenceEnd);
        const status = computeStatus(rec);

        if (!hasReturn && !rec.damagedOrMissing) {
          // Active
          activeCount++;
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${rec.toolName}</td>
            <td>${rec.techName}</td>
            <td>${rec.jobName}</td>
            <td>${checkoutDateStr}</td>
            <td>${daysOut}</td>
            <td>
              <span class="badge status-badge ${status.style}">
                ${status.label}
              </span>
            </td>
            <td>${rec.reason}</td>
            <td class="text-capitalize">${rec.conditionAtCheckout}</td>
            <td>
              <button class="btn btn-sm btn-success me-2"
                      data-action="checkin" data-id="${rec.id}">
                Check In
              </button>
              <button class="btn btn-sm btn-outline-danger"
                      data-action="damage" data-id="${rec.id}">
                Damaged / Missing
              </button>
            </td>
          `;
          activeBody.appendChild(tr);
        } else {
          // History (returned or damaged/missing)
          historyCount++;
          const returnDateStr = rec.returnDate
            ? new Date(rec.returnDate).toLocaleDateString()
            : "-";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${rec.toolName}</td>
            <td>${rec.techName}</td>
            <td>${rec.jobName}</td>
            <td>${checkoutDateStr}</td>
            <td>${returnDateStr}</td>
            <td>${daysOut}</td>
            <td>
              <span class="badge status-badge ${status.style}">
                ${status.label}
              </span>
            </td>
            <td class="text-capitalize">
              ${rec.conditionAtReturn ? rec.conditionAtReturn : "-"}
            </td>
            <td>${rec.damageNotes ? rec.damageNotes : ""}</td>
          `;
          historyBody.appendChild(tr);
        }
      });

      noActiveMsg.classList.toggle("d-none", activeCount !== 0);
      noHistoryMsg.classList.toggle("d-none", historyCount !== 0);
    }

    // --- Form + button handlers ---

    function handleCheckoutSubmit(event) {
      event.preventDefault();

      const toolName = document.getElementById("toolName").value.trim();
      const toolCondition = document.getElementById("toolCondition").value;
      const checkoutDateInput = document.getElementById("checkoutDate").value;
      const techName = document.getElementById("techName").value.trim();
      const jobName = document.getElementById("jobName").value.trim();
      const reason = document.getElementById("reason").value.trim();

      if (!toolName || !checkoutDateInput || !techName || !jobName || !reason) {
        alert("Please fill in all fields.");
        return;
      }

      const checkoutISO = new Date(checkoutDateInput).toISOString();

      const record = {
        id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
        toolName,
        conditionAtCheckout: toolCondition,
        checkoutDate: checkoutISO,
        techName,
        jobName,
        reason,
        // later fields:
        returnDate: null,
        conditionAtReturn: null,
        damagedOrMissing: false,
        damageNotes: ""
      };

      records.push(record);

      // Log checkout to Google Sheets (daysOut = 0)
      logToGoogleSheets("checkout", record, 0);

      saveRecords();
      renderTables();

      event.target.reset();
      document.getElementById("checkoutDate").value = todayAsInputDate();
      document.getElementById("toolCondition").value = "working";
    }

    function handleActiveTableClick(event) {
      const btn = event.target.closest("button[data-action]");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      const index = findRecordIndex(id);
      if (index === -1) return;

      if (action === "checkin") {
        const rec = records[index];
        if (rec.returnDate || rec.damagedOrMissing) {
          return;
        }

        const conditionInput = prompt(
          "Condition on return? Type 'working' or 'not working'. (Default: working)"
        );
        let condition = "working";
        if (conditionInput && conditionInput.toLowerCase().includes("not")) {
          condition = "not working";
        }

        const now = new Date();
        rec.returnDate = now.toISOString();
        rec.conditionAtReturn = condition;

        const daysOutAtEvent = daysBetween(
          new Date(rec.checkoutDate),
          now
        );

        // Log check-in to Google Sheets
        logToGoogleSheets("checkin", rec, daysOutAtEvent);

        saveRecords();
        renderTables();
      }

      if (action === "damage") {
        const rec = records[index];
        const notes = prompt(
          "Describe damage or why the tool is missing. This will be visible to Purchasing / GM:"
        );

        const now = new Date();
        rec.damagedOrMissing = true;
        rec.damageNotes = notes || "";
        if (!rec.returnDate) {
          rec.returnDate = now.toISOString();
        }

        const daysOutAtEvent = daysBetween(
          new Date(rec.checkoutDate),
          now
        );

        // Log damage/missing to Google Sheets
        logToGoogleSheets("damaged_or_missing", rec, daysOutAtEvent);

        saveRecords();
        renderTables();
      }
    }

    // --- Initialize ---

    document.addEventListener("DOMContentLoaded", () => {
      // Default checkout date to today
      document.getElementById("checkoutDate").value = todayAsInputDate();

      loadRecords();
      renderTables();

      document
        .getElementById("checkoutForm")
        .addEventListener("submit", handleCheckoutSubmit);

      document
        .getElementById("activeTableBody")
        .addEventListener("click", handleActiveTableClick);
    });
  </script>
</body>
</html>
