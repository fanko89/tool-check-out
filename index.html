<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tool Check In / Out</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/img/navLogo.png"/>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background-color: #f8f9fa;
    }
    .status-badge {
      font-size: 0.75rem;
    }
    .status-ok {
      background-color: #d1e7dd;
      color: #0f5132;
    }
    .status-warning {
      background-color: #fff3cd;
      color: #664d03;
    }
    .status-danger {
      background-color: #f8d7da;
      color: #842029;
    }
    .status-info {
      background-color: #cff4fc;
      color: #055160;
    }
    .no-print {
      /* default: visible on screen, hidden in print via media query */
    }

    @media print {
      body {
        background-color: #ffffff;
      }
      .no-print {
        display: none !important;
      }
      .card {
        box-shadow: none !important;
        border: none !important;
      }
      .container {
        max-width: 100%;
      }
      .temp-print-hide {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- Logo + Title -->
    <div class="d-flex align-items-center mb-3">
      <img
        src="img/aysp_logo.png"
        alt="Company Logo"
        style="height: 60px; margin-right: 16px;"
      />
      <div>
        <h1 class="mb-1">Tool Check In / Out</h1>
        <p class="text-muted mb-0">
          Tracking for company-owned tools: saws, reclaim units, specialty tools,
          etc. Based on the warehouse check in/out procedure.
        </p>
      </div>
    </div>

    <!-- Top bar: Filters + Export -->
    <div class="card mb-4 no-print">
      <div class="card-header fw-bold d-flex justify-content-between align-items-center">
        <span>Filters &amp; Export</span>
        <button id="exportCsvBtn" class="btn btn-sm btn-outline-secondary">
          Export All Records (CSV)
        </button>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label" for="filterTool">Filter by Tool</label>
            <input type="text" id="filterTool" class="form-control"
                   placeholder="e.g. Reclaim Unit" />
          </div>
          <div class="col-md-4">
            <label class="form-label" for="filterTech">Filter by Technician</label>
            <input type="text" id="filterTech" class="form-control"
                   placeholder="Tech name" />
          </div>
          <div class="col-md-4">
            <label class="form-label" for="filterStatus">Filter by Status</label>
            <select id="filterStatus" class="form-select">
              <option value="all" selected>All</option>
              <option value="active">Active</option>
              <option value="returned">Returned</option>
              <option value="damaged">Damaged / Missing</option>
              <option value="over30">Over 30 days</option>
              <option value="over90">Over 90 days</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Check Out Form -->
    <div class="card mb-4 no-print">
      <div class="card-header fw-bold">Check Out a Tool</div>
      <div class="card-body">
        <form id="checkoutForm" class="row g-3">
          <div class="col-md-4">
            <label for="toolName" class="form-label">Tool</label>
            <input
              type="text"
              id="toolName"
              class="form-control"
              required
              placeholder="e.g. Reclaim Unit, Panel Saw"
              list="toolPresets"
            />
            <!-- Dynamic presets: filled from history via JS -->
            <datalist id="toolPresets">
              <!-- options will be injected based on existing records -->
            </datalist>
          </div>

          <div class="col-md-4">
            <label for="toolCondition" class="form-label">Condition at Checkout</label>
            <select id="toolCondition" class="form-select" required>
              <option value="working" selected>Working</option>
              <option value="not working">Not working</option>
            </select>
          </div>

          <div class="col-md-4">
            <label for="checkoutDate" class="form-label">Checkout Date</label>
            <input type="date" id="checkoutDate" class="form-control" required />
          </div>

          <div class="col-md-4">
            <label for="techName" class="form-label">Technician / Installer</label>
            <input type="text" id="techName" class="form-control" required
                   placeholder="Tech name" />
          </div>

          <div class="col-md-4">
            <label for="jobName" class="form-label">Job / Work Order</label>
            <input type="text" id="jobName" class="form-control" required
                   placeholder="Job name/number" />
          </div>

          <!-- Approved By (authorized person) -->
          <div class="col-md-4">
            <label for="approvedBy" class="form-label">
              Approved By (Warehouse / Parts)
            </label>
            <input
              type="text"
              id="approvedBy"
              class="form-control"
              required
              placeholder="Name of approver"
            />
          </div>

          <div class="col-md-12">
            <label for="reason" class="form-label">Reason for Request</label>
            <textarea id="reason" class="form-control" rows="2" required
                      placeholder="Explain why the tech requested this tool"></textarea>
          </div>

          <div class="col-12 d-flex justify-content-between align-items-center">
            <div class="text-muted small">
              Initial review at 30 days â€¢ Hard limit 90 days (exceptions by warehouse manager).
            </div>
            <button type="submit" class="btn btn-primary">
              Check Out Tool
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Active Checkouts -->
    <div class="card mb-4" id="activeCard">
      <div class="card-header fw-bold d-flex justify-content-between align-items-center">
        <span>Active Tool Checkouts</span>
        <button id="printCheckoutBtn" class="btn btn-sm btn-outline-secondary no-print">
          Print Checkout Sheet
        </button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Tech</th>
                <th>Job</th>
                <th>Checkout Date</th>
                <th>Days Out</th>
                <th>Status</th>
                <th>Reason</th>
                <th>Condition @ Out</th>
                <th>Approved By</th>
                <th style="width: 160px;" class="no-print">Actions</th>
              </tr>
            </thead>
            <tbody id="activeTableBody">
              <!-- Active rows injected here -->
            </tbody>
          </table>
        </div>
        <p id="noActiveMsg" class="text-muted small mb-0 d-none">
          No active tool checkouts.
        </p>
      </div>
    </div>

    <!-- Exceptions / Issues (Purchasing / GM View) -->
    <div class="card mb-4" id="issuesCard">
      <div class="card-header fw-bold d-flex justify-content-between align-items-center">
        <span>Exceptions &amp; Issues (Purchasing / GM View)</span>
        <div class="d-flex align-items-center gap-2">
          <span class="text-muted small">
            Shows tools over 30 days and any damaged / missing items.
          </span>
          <button id="printIssuesBtn" class="btn btn-sm btn-outline-secondary no-print">
            Print Exceptions / Issues
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Tech</th>
                <th>Job</th>
                <th>Checkout</th>
                <th>Return</th>
                <th>Days Out</th>
                <th>Status</th>
                <th>Approved By</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="issuesTableBody">
              <!-- Issues rows injected here -->
            </tbody>
          </table>
        </div>
        <p id="noIssuesMsg" class="text-muted small mb-0 d-none">
          No exceptions or issues at this time.
        </p>
      </div>
    </div>

    <!-- History -->
    <div class="card" id="historyCard">
      <div class="card-header fw-bold d-flex justify-content-between align-items-center">
        <span>Returned / Closed Records</span>
        <button id="printHistoryBtn" class="btn btn-sm btn-outline-secondary no-print">
          Print Returned / Closed
        </button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Tool</th>
                <th>Tech</th>
                <th>Job</th>
                <th>Checkout</th>
                <th>Return</th>
                <th>Days Out</th>
                <th>Final Status</th>
                <th>Condition @ Return</th>
                <th>Approved By</th>
                <th>Damage / Missing Notes</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <!-- History rows injected here -->
            </tbody>
          </table>
        </div>
        <p id="noHistoryMsg" class="text-muted small mb-0 d-none">
          No closed records yet.
        </p>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzcBDEAHSjFkuIbHjPsX_4gaJTZkIZcV4ZnqWtyABw6gHCoGbTLAd82_Ztvt34HRu1t/exec";

    let records = [];
    const filters = { tool: "", tech: "", status: "all" };
    let lastCheckoutSubmitMs = 0; // 30s duplicate guard

    // --- Helpers for dates & status ---

    function todayAsInputDate() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function daysBetween(start, end) {
      const s = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      const e = new Date(end.getFullYear(), end.getMonth(), end.getDate());
      const diff = e - s;
      const msPerDay = 1000 * 60 * 60 * 24;
      return Math.floor(diff / msPerDay);
    }

    function computeStatus(rec) {
      if (rec.damagedOrMissing) {
        return { label: "Damaged / Missing", style: "status-danger" };
      }
      if (rec.returnDate) {
        return { label: "Returned", style: "status-info" };
      }
      const checkout = new Date(rec.checkoutDate);
      const now = new Date();
      const d = daysBetween(checkout, now);
      if (d > 90) {
        return {
          label: "Over 90 days â€“ must be checked in / exception required",
          style: "status-danger"
        };
      }
      if (d > 30) {
        return {
          label: "Over 30 days â€“ contact tech about tool",
          style: "status-warning"
        };
      }
      if (d >= 20) {
        return {
          label: "Approaching 30 days â€“ review",
          style: "status-warning"
        };
      }
      return { label: "OK", style: "status-ok" };
    }

    function findRecordIndex(id) {
      return records.findIndex(r => r.id === id);
    }

    function saveRecords() {
      // Optional: local cache if you want
      // localStorage.setItem("toolCheckouts_v1", JSON.stringify(records));
    }

    // --- Build Tool presets datalist from existing records ---

    function rebuildToolPresets() {
      const datalist = document.getElementById("toolPresets");
      if (!datalist) return;

      datalist.innerHTML = "";
      const seen = new Set();

      records.forEach(rec => {
        const nameRaw = rec.toolName || "";
        const name = nameRaw.trim();
        if (!name) return;

        const key = name.toLowerCase();
        if (seen.has(key)) return;
        seen.add(key);

        const opt = document.createElement("option");
        opt.value = name;
        datalist.appendChild(opt);
      });
    }

    // --- Google Sheets logging (write) ---

    async function logToGoogleSheets(action, rec, daysOutAtEvent, approvedBy) {
      if (!GOOGLE_APPS_SCRIPT_URL) {
        console.warn("GOOGLE_APPS_SCRIPT_URL is not set; skipping Sheets log.");
        return;
      }

      const payload = {
        action,
        id: rec.id,
        toolName: rec.toolName,
        techName: rec.techName,
        jobName: rec.jobName,
        reason: rec.reason,
        checkoutDate: rec.checkoutDate,
        returnDate: rec.returnDate,
        conditionAtCheckout: rec.conditionAtCheckout,
        conditionAtReturn: rec.conditionAtReturn,
        damagedOrMissing: rec.damagedOrMissing,
        damageNotes: rec.damageNotes,
        daysOut: daysOutAtEvent,
        approvedBy: approvedBy || rec.approvedBy || ""
      };

      try {
        const res = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          console.error("Sheets log HTTP error:", res.status, await res.text());
        }
      } catch (err) {
        console.error("Failed to log to Google Sheets:", err);
      }
    }

    // --- Google Sheets READ (shared source of truth) ---

    async function loadRecordsFromSheets() {
      try {
        const res = await fetch(GOOGLE_APPS_SCRIPT_URL);
        if (!res.ok) {
          console.error("Failed to load from Sheets:", res.status);
          records = [];
          return;
        }

        const data = await res.json();
        const events = Array.isArray(data.rows) ? data.rows : [];

        events.sort((a, b) => {
          const ta = new Date(a.timestamp).getTime();
          const tb = new Date(b.timestamp).getTime();
          return ta - tb;
        });

        const recordMap = new Map();

        events.forEach(ev => {
          const id = ev.id;
          if (!id) return;

          const action = (ev.action || "").toLowerCase();

          if (action === "checkout") {
            recordMap.set(id, {
              id: id,
              toolName: ev.toolName || "",
              conditionAtCheckout: ev.conditionAtCheckout || "working",
              checkoutDate: ev.checkoutDate || new Date().toISOString(),
              techName: ev.techName || "",
              jobName: ev.jobName || "",
              reason: ev.reason || "",
              returnDate: null,
              conditionAtReturn: null,
              damagedOrMissing: false,
              damageNotes: "",
              approvedBy: ev.approvedBy || ""
            });
          } else if (action === "checkin") {
            const rec = recordMap.get(id);
            if (!rec) return;
            rec.returnDate = ev.returnDate || rec.returnDate || new Date().toISOString();
            if (ev.conditionAtReturn) {
              rec.conditionAtReturn = ev.conditionAtReturn;
            }
            if (ev.approvedBy) {
              rec.approvedBy = ev.approvedBy;
            }
          } else if (
            action === "damaged_or_missing" ||
            action === "damaged" ||
            action === "damage"
          ) {
            const rec = recordMap.get(id);
            if (!rec) return;
            rec.damagedOrMissing = true;
            if (ev.damageNotes) {
              rec.damageNotes = ev.damageNotes;
            }
            if (!rec.returnDate) {
              rec.returnDate = ev.returnDate || new Date().toISOString();
            }
            if (ev.approvedBy) {
              rec.approvedBy = ev.approvedBy;
            }
          }
        });

        records = Array.from(recordMap.values());
        saveRecords();
        rebuildToolPresets(); // build suggestions from loaded tools
      } catch (err) {
        console.error("Error loading records from Sheets:", err);
        records = [];
      }
    }

    // --- Check if a tool is allowed to be checked out ---

    function canCheckoutTool(toolName) {
      const target = (toolName || "").trim().toLowerCase();
      if (!target) return true;

      for (const rec of records) {
        const name = (rec.toolName || "").trim().toLowerCase();
        if (!name || name !== target) continue;

        const hasReturn = !!rec.returnDate;
        const isDamaged = rec.damagedOrMissing === true;

        const condOut = (rec.conditionAtCheckout || "").toLowerCase();
        const condRet = (rec.conditionAtReturn || "").toLowerCase();

        const isNotWorking =
          condRet.includes("not working") ||
          (!hasReturn && condOut.includes("not working"));

        // 1) Already checked out & not marked damaged
        if (!hasReturn && !isDamaged) {
          const tech = rec.techName || "unknown tech";
          const dateStr = rec.checkoutDate
            ? new Date(rec.checkoutDate).toLocaleDateString()
            : "unknown date";
          alert(
            `Cannot check out "${toolName}" because it is already checked out to ${tech} (checked out ${dateStr}).`
          );
          return false;
        }

        // 2) Marked damaged / missing
        if (isDamaged) {
          const notes = rec.damageNotes || "Tool is marked damaged or missing.";
          alert(
            `Cannot check out "${toolName}" because it is marked damaged/missing.\n\nNotes: ${notes}`
          );
          return false;
        }

        // 3) Returned as NOT WORKING
        if (hasReturn && isNotWorking) {
          const dateStr = rec.returnDate
            ? new Date(rec.returnDate).toLocaleDateString()
            : "unknown date";
          alert(
            `Cannot check out "${toolName}" because it was returned as NOT WORKING on ${dateStr}.\n` +
            `Please repair/replace or clear the status before checking it out again.`
          );
          return false;
        }
      }

      return true;
    }

    // --- Filters ---

    function matchesFilters(rec) {
      const toolFilter = filters.tool.trim().toLowerCase();
      const techFilter = filters.tech.trim().toLowerCase();
      const statusFilter = filters.status;

      const checkoutDate = new Date(rec.checkoutDate);
      const now = new Date();
      const daysOutNow = daysBetween(checkoutDate, now);

      if (toolFilter) {
        const toolName = (rec.toolName || "").toLowerCase();
        if (!toolName.includes(toolFilter)) return false;
      }

      if (techFilter) {
        const techName = (rec.techName || "").toLowerCase();
        if (!techName.includes(techFilter)) return false;
      }

      if (statusFilter === "all") return true;

      const isActive = !rec.returnDate && !rec.damagedOrMissing;
      const isReturned = !!rec.returnDate && !rec.damagedOrMissing;
      const isDamaged = !!rec.damagedOrMissing;
      const isOver30 = daysOutNow > 30;
      const isOver90 = daysOutNow > 90;

      switch (statusFilter) {
        case "active":
          return isActive;
        case "returned":
          return isReturned;
        case "damaged":
          return isDamaged;
        case "over30":
          return isOver30;
        case "over90":
          return isOver90;
        default:
          return true;
      }
    }

    // --- Rendering tables ---

    function renderTables() {
      const activeBody = document.getElementById("activeTableBody");
      const historyBody = document.getElementById("historyTableBody");
      const issuesBody = document.getElementById("issuesTableBody");

      const noActiveMsg = document.getElementById("noActiveMsg");
      const noHistoryMsg = document.getElementById("noHistoryMsg");
      const noIssuesMsg = document.getElementById("noIssuesMsg");

      activeBody.innerHTML = "";
      historyBody.innerHTML = "";
      issuesBody.innerHTML = "";

      let activeCount = 0;
      let historyCount = 0;
      let issuesCount = 0;

      records.forEach(rec => {
        const checkoutDate = new Date(rec.checkoutDate);
        const checkoutDateStr = checkoutDate.toLocaleDateString();

        const hasReturn = !!rec.returnDate;
        const referenceEnd = hasReturn ? new Date(rec.returnDate) : new Date();
        const daysOut = daysBetween(new Date(rec.checkoutDate), referenceEnd);
        const status = computeStatus(rec);

        if (matchesFilters(rec)) {
          if (!hasReturn && !rec.damagedOrMissing) {
            activeCount++;
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${rec.toolName}</td>
              <td>${rec.techName}</td>
              <td>${rec.jobName}</td>
              <td>${checkoutDateStr}</td>
              <td>${daysOut}</td>
              <td>
                <span class="badge status-badge ${status.style}">
                  ${status.label}
                </span>
              </td>
              <td>${rec.reason}</td>
              <td class="text-capitalize">${rec.conditionAtCheckout}</td>
              <td>${rec.approvedBy ? rec.approvedBy : "-"}</td>
              <td class="no-print">
                <button class="btn btn-sm btn-success me-2"
                        data-action="checkin" data-id="${rec.id}">
                  Check In
                </button>
                <button class="btn btn-sm btn-outline-danger"
                        data-action="damage" data-id="${rec.id}">
                  Damaged / Missing
                </button>
              </td>
            `;
            activeBody.appendChild(tr);
          } else {
            historyCount++;
            const returnDateStr = rec.returnDate
              ? new Date(rec.returnDate).toLocaleDateString()
              : "-";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${rec.toolName}</td>
              <td>${rec.techName}</td>
              <td>${rec.jobName}</td>
              <td>${checkoutDateStr}</td>
              <td>${returnDateStr}</td>
              <td>${daysOut}</td>
              <td>
                <span class="badge status-badge ${status.style}">
                  ${status.label}
                </span>
              </td>
              <td class="text-capitalize">
                ${rec.conditionAtReturn ? rec.conditionAtReturn : "-"}
              </td>
              <td>${rec.approvedBy ? rec.approvedBy : "-"}</td>
              <td>${rec.damageNotes ? rec.damageNotes : ""}</td>
            `;
            historyBody.appendChild(tr);
          }
        }

        const isOver30Active =
          !hasReturn &&
          !rec.damagedOrMissing &&
          daysOut > 30;

        const isDamaged = rec.damagedOrMissing === true;

        if (isOver30Active || isDamaged) {
          issuesCount++;
          const returnDateStr = rec.returnDate
            ? new Date(rec.returnDate).toLocaleDateString()
            : "-";

          const notes =
            rec.damagedOrMissing
              ? (rec.damageNotes || "Damaged / missing â€“ review with Purchasing / GM")
              : "Over 30 days â€“ contact technician and warehouse";

          const trIssues = document.createElement("tr");
          trIssues.innerHTML = `
            <td>${rec.toolName}</td>
            <td>${rec.techName}</td>
            <td>${rec.jobName}</td>
            <td>${checkoutDateStr}</td>
            <td>${returnDateStr}</td>
            <td>${daysOut}</td>
            <td>
              <span class="badge status-badge ${status.style}">
                ${status.label}
              </span>
            </td>
            <td>${rec.approvedBy ? rec.approvedBy : "-"}</td>
            <td>${notes}</td>
          `;
          issuesBody.appendChild(trIssues);
        }
      });

      noActiveMsg.classList.toggle("d-none", activeCount !== 0);
      noHistoryMsg.classList.toggle("d-none", historyCount !== 0);
      noIssuesMsg.classList.toggle("d-none", issuesCount !== 0);
    }

    // --- CSV Export ---

    function exportCsv() {
      if (!records.length) {
        alert("No records to export.");
        return;
      }

      const header = [
        "Record ID",
        "Tool Name",
        "Tech Name",
        "Job Name",
        "Reason",
        "Checkout Date",
        "Return Date",
        "Condition @ Checkout",
        "Condition @ Return",
        "Damaged / Missing",
        "Damage Notes",
        "Days Out (now)",
        "Approved By",
        "Status"
      ];

      const rows = records.map(rec => {
        const checkoutDate = rec.checkoutDate ? new Date(rec.checkoutDate) : null;
        const returnDate = rec.returnDate ? new Date(rec.returnDate) : null;

        const endRef = returnDate || new Date();
        const daysOut = checkoutDate ? daysBetween(checkoutDate, endRef) : "";

        const status = computeStatus(rec);

        function fmtDate(d) {
          return d ? d.toLocaleDateString() : "";
        }

        return [
          rec.id || "",
          rec.toolName || "",
          rec.techName || "",
          rec.jobName || "",
          rec.reason || "",
          fmtDate(checkoutDate),
          fmtDate(returnDate),
          rec.conditionAtCheckout || "",
          rec.conditionAtReturn || "",
          rec.damagedOrMissing ? "TRUE" : "FALSE",
          rec.damageNotes || "",
          daysOut,
          rec.approvedBy || "",
          status.label || ""
        ];
      });

      const csvLines = [];
      csvLines.push(header.join(","));
      rows.forEach(row => {
        const escaped = row.map(value => {
          const v = String(value).replace(/"/g, '""');
          if (v.search(/("|,|\n)/g) >= 0) {
            return `"${v}"`;
          }
          return v;
        });
        csvLines.push(escaped.join(","));
      });

      const csvContent = csvLines.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = "tool_checkin_checkout.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // --- Print only one section ---

    function printSection(cardId) {
      const cards = document.querySelectorAll(".card");
      const hidden = [];
      cards.forEach(card => {
        if (card.id !== cardId) {
          card.classList.add("temp-print-hide");
          hidden.push(card);
        }
      });

      window.print();

      hidden.forEach(card => card.classList.remove("temp-print-hide"));
    }

    // --- Form + button handlers ---

    async function handleCheckoutSubmit(event) {
      event.preventDefault();

      const toolName = document.getElementById("toolName").value.trim();
      const toolCondition = document.getElementById("toolCondition").value;
      const checkoutDateInput = document.getElementById("checkoutDate").value;
      const techName = document.getElementById("techName").value.trim();
      const jobName = document.getElementById("jobName").value.trim();
      const approvedBy = document.getElementById("approvedBy").value.trim();
      const reason = document.getElementById("reason").value.trim();

      if (!toolName || !checkoutDateInput || !techName || !jobName || !reason || !approvedBy) {
        alert("Please fill in all fields (including Approved By).");
        return;
      }

      const nowMs = Date.now();
      if (nowMs - lastCheckoutSubmitMs < 30000) {
        alert(
          "You just submitted a checkout less than 30 seconds ago. " +
          "Please wait a moment to avoid duplicate entries."
        );
        return;
      }

      // ðŸš« Check tool availability before creating record
      if (!canCheckoutTool(toolName)) {
        return;
      }

      lastCheckoutSubmitMs = nowMs;

      const checkoutISO = new Date(checkoutDateInput).toISOString();

      const record = {
        id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
        toolName,
        conditionAtCheckout: toolCondition,
        checkoutDate: checkoutISO,
        techName,
        jobName,
        reason,
        returnDate: null,
        conditionAtReturn: null,
        damagedOrMissing: false,
        damageNotes: "",
        approvedBy
      };

      records.push(record);
      rebuildToolPresets(); // make sure new tool is in suggestions

      await logToGoogleSheets("checkout", record, 0, approvedBy);

      saveRecords();
      renderTables();

      event.target.reset();
      document.getElementById("checkoutDate").value = todayAsInputDate();
      document.getElementById("toolCondition").value = "working";
    }

    async function handleActiveTableClick(event) {
      const btn = event.target.closest("button[data-action]");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      const index = findRecordIndex(id);
      if (index === -1) return;

      if (action === "checkin") {
        const rec = records[index];
        if (rec.returnDate || rec.damagedOrMissing) {
          return;
        }

        const conditionInput = prompt(
          "Condition on return? Type 'working' or 'not working'. (Default: working)"
        );
        let condition = "working";
        if (conditionInput && conditionInput.toLowerCase().includes("not")) {
          condition = "not working";
        }

        const approvedBy = prompt(
          "Name of the person approving this check-in (warehouse/parts):"
        ) || "";

        const now = new Date();
        rec.returnDate = now.toISOString();
        rec.conditionAtReturn = condition;
        if (approvedBy) rec.approvedBy = approvedBy;

        const daysOutAtEvent = daysBetween(
          new Date(rec.checkoutDate),
          now
        );

        await logToGoogleSheets("checkin", rec, daysOutAtEvent, approvedBy);

        saveRecords();
        renderTables();
      }

      if (action === "damage") {
        const rec = records[index];
        const notes = prompt(
          "Describe damage or why the tool is missing. This will be visible to Purchasing / GM:"
        );

        const approvedBy = prompt(
          "Name of the person approving this damage/missing record (warehouse/parts):"
        ) || "";

        const now = new Date();
        rec.damagedOrMissing = true;
        rec.damageNotes = notes || "";
        if (!rec.returnDate) {
          rec.returnDate = now.toISOString();
        }
        if (approvedBy) rec.approvedBy = approvedBy;

        const daysOutAtEvent = daysBetween(
          new Date(rec.checkoutDate),
          now
        );

        await logToGoogleSheets("damaged_or_missing", rec, daysOutAtEvent, approvedBy);

        saveRecords();
        renderTables();
      }
    }

    function handleFilterChange() {
      filters.tool = document.getElementById("filterTool").value;
      filters.tech = document.getElementById("filterTech").value;
      filters.status = document.getElementById("filterStatus").value;
      renderTables();
    }

    // --- Initialize ---

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("checkoutDate").value = todayAsInputDate();

      await loadRecordsFromSheets();
      renderTables();

      document
        .getElementById("checkoutForm")
        .addEventListener("submit", handleCheckoutSubmit);

      document
        .getElementById("activeTableBody")
        .addEventListener("click", handleActiveTableClick);

      document
        .getElementById("filterTool")
        .addEventListener("input", handleFilterChange);
      document
        .getElementById("filterTech")
        .addEventListener("input", handleFilterChange);
      document
        .getElementById("filterStatus")
        .addEventListener("change", handleFilterChange);

      document
        .getElementById("exportCsvBtn")
        .addEventListener("click", exportCsv);

      const printCheckoutBtn = document.getElementById("printCheckoutBtn");
      const printIssuesBtn = document.getElementById("printIssuesBtn");
      const printHistoryBtn = document.getElementById("printHistoryBtn");

      if (printCheckoutBtn) {
        printCheckoutBtn.addEventListener("click", () => printSection("activeCard"));
      }
      if (printIssuesBtn) {
        printIssuesBtn.addEventListener("click", () => printSection("issuesCard"));
      }
      if (printHistoryBtn) {
        printHistoryBtn.addEventListener("click", () => printSection("historyCard"));
      }
    });
  </script>
</body>
</html>
